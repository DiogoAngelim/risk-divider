name: Build and Release Electron App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install

      - name: Build React frontend
        run: cd app && npm install && npm run build

      - name: Build Electron App
        run: |
          if [ "${{ matrix.os }}" == "macos-latest" ]; then
            npm run make:mac
          else
            npm run make:win
          fi

      - name: Set platform variables
        run: |
          if [ "${{ matrix.os }}" == "macos-latest" ]; then
            echo "PLATFORM=mac" >> $GITHUB_ENV
            BUILD_FILE=$(ls dist/*.app | head -n1)
          else
            echo "PLATFORM=win" >> $GITHUB_ENV
            BUILD_FILE=$(ls dist/*.exe dist/*.msi dist/*.zip | head -n1)
          fi
          echo "BUILD_FILE=$BUILD_FILE" >> $GITHUB_ENV

      - name: Zip build output
        run: |
          ZIP_NAME=risk-divider-${PLATFORM}.zip
          if [ "${PLATFORM}" == "mac" ]; then
            cd dist
            zip -r $ZIP_NAME *.app
          else
            cd dist
            powershell Compress-Archive -Path * -DestinationPath $ZIP_NAME
          fi
          echo "ZIP_FILE=dist/$ZIP_NAME" >> $GITHUB_ENV

      - name: Set asset name
        run: |
          ZIP_BASENAME=$(basename $ZIP_FILE)
          echo "ASSET_NAME=$ZIP_BASENAME" >> $GITHUB_ENV

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v$(node -p "require('./package.json').version")
          release_name: v$(node -p "require('./package.json').version")
          draft: false
          prerelease: false

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.ZIP_FILE }}
          asset_name: ${{ env.ASSET_NAME }}
          asset_content_type: application/zip
